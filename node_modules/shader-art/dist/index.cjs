"use strict";var c=Object.defineProperty;var m=Object.getOwnPropertyDescriptor;var v=Object.getOwnPropertyNames;var b=Object.prototype.hasOwnProperty;var w=(s,n)=>{for(var e in n)c(s,e,{get:n[e],enumerable:!0})},S=(s,n,e,i)=>{if(n&&typeof n=="object"||typeof n=="function")for(let t of v(n))!b.call(s,t)&&t!==e&&c(s,t,{get:()=>n[t],enumerable:!(i=m(n,t))||i.enumerable});return s};var y=s=>S(c({},"__esModule",{value:!0}),s);var x={};w(x,{ShaderArt:()=>u,Stopwatch:()=>d,prefersReducedMotion:()=>l});module.exports=y(x);var d=class{constructor(){this._startTime=NaN;this._totalElapsed=0;this._running=!1}start(){return this._startTime=performance.now(),this._running=!0,this}stop(){return this._running&&(this._running=!1,this._totalElapsed+=performance.now()-this._startTime),this}reset(){return this._totalElapsed=0,this._startTime=this._running?performance.now():NaN,this}get running(){return this._running}get elapsedTime(){return this._running?this._totalElapsed+performance.now()-this._startTime:this._totalElapsed}};var A=s=>({media:s,addListener(){},removeListener(){},addEventListener(){},removeEventListener(){},matches:!1,onchange:null}),P=s=>("onchange"in s||(s.onchange=null,s.addEventListener=(n,e)=>{s.addListener(e==null?void 0:e.bind(s))},s.removeEventListener=(n,e)=>{s.removeListener(e==null?void 0:e.bind(s))}),s);function R(s){return typeof window!="undefined"&&"matchMedia"in window&&P(window.matchMedia(s))||A(s)}function l(){return R("(prefers-reduced-motion: reduce)")}var p="precision highp float;",E=p+"attribute vec4 position;void main(){gl_Position=position;}",L=p+"void main(){gl_FragColor=vec4(1.,0,0,1.);}",f=class extends HTMLElement{constructor(){super();this.buffers={};this.canvas=null;this.initialized=!1;this.gl=null;this.program=null;this.frame=-1;this.count=0;this.fragShader=null;this.vertShader=null;this.activePlugins=[];this.prefersReducedMotion=l(),this.onResize=this.onResize.bind(this),this.renderLoop=this.renderLoop.bind(this),this.onChangeReducedMotion=this.onChangeReducedMotion.bind(this),this.frame=-1,this.watch=new d}static register(e=[]){f.plugins=e,typeof customElements.get("shader-art")=="undefined"&&customElements.define("shader-art",f)}static get observedAttributes(){return["play-state","autoplay"]}connectedCallback(){this.gl||this.setup()}disconnectedCallback(){this.dispose()}attributeChangedCallback(e){e==="play-state"&&this.gl&&this._updatePlaystate(),e==="autoplay"&&this.gl&&(this.playState="running")}get fragCode(){let e=this.querySelector('[type="text/frag"], [type=frag]');return((e==null?void 0:e.textContent)||L).trim()}get vertCode(){let e=this.querySelector('[type="text/vert"], [type=vert]');return((e==null?void 0:e.textContent)||E).trim()}get webgl2(){return this.fragCode.includes("#version 300 es")}get devicePixelRatio(){return Math.min(parseFloat(this.getAttribute("dpr")||"1"),window.devicePixelRatio)}set playState(e){this.setAttribute("play-state",e)}get playState(){return this.getAttribute("play-state")==="stopped"?"stopped":"running"}set autoPlay(e){e?this.setAttribute("autoplay",""):this.removeAttribute("autoplay")}get autoPlay(){return this.hasAttribute("autoplay")}_updatePlaystate(){let{prefersReducedMotion:e}=this;if((this.playState==="stopped"||e.matches)&&this.frame>-1){let i=this.frame;this.frame=-1,cancelAnimationFrame(i),this.watch.stop()}this.playState==="running"&&e.matches===!1&&this.frame===-1&&(this.frame=requestAnimationFrame(this.renderLoop),this.watch.start())}onResize(){let{canvas:e,gl:i,program:t}=this,r=this.clientWidth,a=this.clientHeight,o=this.devicePixelRatio;if(e&&i&&t){e.width=r*o,e.height=a*o,i.viewport(0,0,i.drawingBufferWidth,i.drawingBufferHeight);let h=i.getUniformLocation(t,"resolution");i.uniform2fv(h,[i.drawingBufferWidth,i.drawingBufferHeight]),this.render()}}onChangeReducedMotion(){this._updatePlaystate()}createShader(e,i){let{gl:t}=this;if(!t)return null;let r=t.createShader(e);if(!r)return null;if(t.shaderSource(r,i),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS))throw t.getShaderInfoLog(r);return r}addBuffer(e,i,t){let{gl:r,program:a}=this;if(!r||!a)throw Error("addBuffer failed: gl context not initialized.");let o=r.createBuffer();if(!o)throw Error("gl.createBuffer failed.");r.bindBuffer(r.ARRAY_BUFFER,o),r.bufferData(r.ARRAY_BUFFER,t,r.STATIC_DRAW);let h=r.getAttribLocation(a,e);this.buffers[e]={buffer:o,data:t,attribLoc:h,recordSize:i},r.enableVertexAttribArray(h),r.bindBuffer(r.ARRAY_BUFFER,o),r.vertexAttribPointer(h,i,r.FLOAT,!1,0,0)}createBuffers(){let e=[...this.querySelectorAll('[type="text/buffer"], [type=buffer]')];this.buffers={};let i=-1;e.forEach(t=>{let r=t.getAttribute("id")||t.getAttribute("name")||"position",a=parseInt(t.getAttribute("data-size")||"1",10)||1,o=new Float32Array(JSON.parse((t.textContent||"").trim()));i=Math.max(i,o.length/a|0),this.addBuffer(r,a,o)}),typeof this.buffers.position=="undefined"&&(this.addBuffer("position",2,new Float32Array([-1,-1,-1,1,1,-1,1,-1,1,1,-1,1])),i=6),this.count=i}render(){let{gl:e,program:i,watch:t,initialized:r,canvas:a}=this;if(!e||!i||!r||!a)return;let o=e.getUniformLocation(i,"time"),h=t.elapsedTime*.001;for(let g of this.activePlugins)g.onFrame&&g.onFrame(this,e,i,a);e.uniform1f(o,h),e.drawArrays(e.TRIANGLES,0,this.count)}renderLoop(){this.render(),this.frame=requestAnimationFrame(this.renderLoop)}createPrograms(){let{gl:e}=this;if(!e)throw Error("render failed: gl context not initialized.");let i={fragmentShader:this.fragCode,vertexShader:this.vertCode};for(let r of this.activePlugins)r.onBeforeCompileShader&&r.onBeforeCompileShader(i);let t=e.createProgram();if(!t)throw Error("createProgram failed.");if(this.program=t,this.fragShader=this.createShader(e.FRAGMENT_SHADER,i.fragmentShader),this.vertShader=this.createShader(e.VERTEX_SHADER,i.vertexShader),!this.fragShader||!this.vertShader)throw Error("createShader failed.");if(e.attachShader(t,this.fragShader),e.attachShader(t,this.vertShader),e.linkProgram(t),!e.getProgramParameter(t,e.LINK_STATUS))throw e.getProgramInfoLog(t);e.useProgram(t)}setup(){if(this.gl&&!this.gl.isContextLost())return;let e=document.createElement("canvas");if(e.style.width="100%",e.style.height="100%",e.style.display="block",this.canvas=e,this.appendChild(this.canvas),this.webgl2?this.gl=this.canvas.getContext("webgl2"):this.gl=this.canvas.getContext("webgl")||this.canvas.getContext("experimental-webgl"),!this.gl)throw new Error("WebGL not supported");this.activatePlugins(),this.createPrograms(),this.createBuffers(),this.prefersReducedMotion=l(),this.setupActivePlugins().then(()=>{this.initialized=!0,this.onResize()}),this.addEventListeners(),this.autoPlay&&(this.playState="running")}addEventListeners(){var e;window.addEventListener("resize",this.onResize,!1),(e=this.prefersReducedMotion)==null||e.addEventListener("change",this.onChangeReducedMotion,!1)}deactivatePlugins(){for(let e of this.activePlugins)e.dispose()}activatePlugins(){for(let e of f.plugins){let i=e();this.activePlugins.find(t=>t.name===i.name)||this.activePlugins.push(i)}}setupActivePlugins(){return new Promise((e,i)=>{if(!this.gl||!this.program||!this.canvas){i(Error("WebGL not initialized"));return}let t=[];for(let r of this.activePlugins){let a=r.setup(this,this.gl,this.program,this.canvas);a instanceof Promise&&t.push(a)}Promise.all(t).then(()=>{e()}).catch(r=>{i(r)})})}reinitialize(){this.deactivatePlugins(),this.deleteProgramAndBuffers(),this.createPrograms(),this.createBuffers(),this.activatePlugins(),this.onResize()}deleteProgramAndBuffers(){if(!this.gl)throw Error("no gl context initialized");Object.entries(this.buffers).forEach(([e,i])=>{this.gl&&this.gl.deleteBuffer(i.buffer)}),this.gl.deleteProgram(this.program)}dispose(){if(this.frame>-1&&cancelAnimationFrame(this.frame),this.frame=-1,this.initialized=!1,this.prefersReducedMotion&&this.prefersReducedMotion.removeEventListener("change",this.onChangeReducedMotion,!1),this.watch.reset(),this.deactivatePlugins(),window.removeEventListener("resize",this.onResize,!1),this.deleteProgramAndBuffers(),this.gl){let e=this.gl.getExtension("WEBGL_lose_context");e&&typeof e.loseContext=="function"&&e.loseContext(),this.gl=null}this.canvas&&(this.removeChild(this.canvas),this.canvas=null),this.buffers={}}},u=f;u.plugins=[];
