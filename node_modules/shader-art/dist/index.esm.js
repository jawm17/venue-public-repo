var h=class{constructor(){this._startTime=NaN;this._totalElapsed=0;this._running=!1}start(){return this._startTime=performance.now(),this._running=!0,this}stop(){return this._running&&(this._running=!1,this._totalElapsed+=performance.now()-this._startTime),this}reset(){return this._totalElapsed=0,this._startTime=this._running?performance.now():NaN,this}get running(){return this._running}get elapsedTime(){return this._running?this._totalElapsed+performance.now()-this._startTime:this._totalElapsed}};var p=s=>({media:s,addListener(){},removeListener(){},addEventListener(){},removeEventListener(){},matches:!1,onchange:null}),m=s=>("onchange"in s||(s.onchange=null,s.addEventListener=(f,e)=>{s.addListener(e==null?void 0:e.bind(s))},s.removeEventListener=(f,e)=>{s.removeListener(e==null?void 0:e.bind(s))}),s);function v(s){return typeof window!="undefined"&&"matchMedia"in window&&m(window.matchMedia(s))||p(s)}function l(){return v("(prefers-reduced-motion: reduce)")}var g="precision highp float;",b=g+"attribute vec4 position;void main(){gl_Position=position;}",w=g+"void main(){gl_FragColor=vec4(1.,0,0,1.);}",d=class extends HTMLElement{constructor(){super();this.buffers={};this.canvas=null;this.initialized=!1;this.gl=null;this.program=null;this.frame=-1;this.count=0;this.fragShader=null;this.vertShader=null;this.activePlugins=[];this.prefersReducedMotion=l(),this.onResize=this.onResize.bind(this),this.renderLoop=this.renderLoop.bind(this),this.onChangeReducedMotion=this.onChangeReducedMotion.bind(this),this.frame=-1,this.watch=new h}static register(e=[]){d.plugins=e,typeof customElements.get("shader-art")=="undefined"&&customElements.define("shader-art",d)}static get observedAttributes(){return["play-state","autoplay"]}connectedCallback(){this.gl||this.setup()}disconnectedCallback(){this.dispose()}attributeChangedCallback(e){e==="play-state"&&this.gl&&this._updatePlaystate(),e==="autoplay"&&this.gl&&(this.playState="running")}get fragCode(){let e=this.querySelector('[type="text/frag"], [type=frag]');return((e==null?void 0:e.textContent)||w).trim()}get vertCode(){let e=this.querySelector('[type="text/vert"], [type=vert]');return((e==null?void 0:e.textContent)||b).trim()}get webgl2(){return this.fragCode.includes("#version 300 es")}get devicePixelRatio(){return Math.min(parseFloat(this.getAttribute("dpr")||"1"),window.devicePixelRatio)}set playState(e){this.setAttribute("play-state",e)}get playState(){return this.getAttribute("play-state")==="stopped"?"stopped":"running"}set autoPlay(e){e?this.setAttribute("autoplay",""):this.removeAttribute("autoplay")}get autoPlay(){return this.hasAttribute("autoplay")}_updatePlaystate(){let{prefersReducedMotion:e}=this;if((this.playState==="stopped"||e.matches)&&this.frame>-1){let t=this.frame;this.frame=-1,cancelAnimationFrame(t),this.watch.stop()}this.playState==="running"&&e.matches===!1&&this.frame===-1&&(this.frame=requestAnimationFrame(this.renderLoop),this.watch.start())}onResize(){let{canvas:e,gl:t,program:i}=this,r=this.clientWidth,n=this.clientHeight,a=this.devicePixelRatio;if(e&&t&&i){e.width=r*a,e.height=n*a,t.viewport(0,0,t.drawingBufferWidth,t.drawingBufferHeight);let o=t.getUniformLocation(i,"resolution");t.uniform2fv(o,[t.drawingBufferWidth,t.drawingBufferHeight]),this.render()}}onChangeReducedMotion(){this._updatePlaystate()}createShader(e,t){let{gl:i}=this;if(!i)return null;let r=i.createShader(e);if(!r)return null;if(i.shaderSource(r,t),i.compileShader(r),!i.getShaderParameter(r,i.COMPILE_STATUS))throw i.getShaderInfoLog(r);return r}addBuffer(e,t,i){let{gl:r,program:n}=this;if(!r||!n)throw Error("addBuffer failed: gl context not initialized.");let a=r.createBuffer();if(!a)throw Error("gl.createBuffer failed.");r.bindBuffer(r.ARRAY_BUFFER,a),r.bufferData(r.ARRAY_BUFFER,i,r.STATIC_DRAW);let o=r.getAttribLocation(n,e);this.buffers[e]={buffer:a,data:i,attribLoc:o,recordSize:t},r.enableVertexAttribArray(o),r.bindBuffer(r.ARRAY_BUFFER,a),r.vertexAttribPointer(o,t,r.FLOAT,!1,0,0)}createBuffers(){let e=[...this.querySelectorAll('[type="text/buffer"], [type=buffer]')];this.buffers={};let t=-1;e.forEach(i=>{let r=i.getAttribute("id")||i.getAttribute("name")||"position",n=parseInt(i.getAttribute("data-size")||"1",10)||1,a=new Float32Array(JSON.parse((i.textContent||"").trim()));t=Math.max(t,a.length/n|0),this.addBuffer(r,n,a)}),typeof this.buffers.position=="undefined"&&(this.addBuffer("position",2,new Float32Array([-1,-1,-1,1,1,-1,1,-1,1,1,-1,1])),t=6),this.count=t}render(){let{gl:e,program:t,watch:i,initialized:r,canvas:n}=this;if(!e||!t||!r||!n)return;let a=e.getUniformLocation(t,"time"),o=i.elapsedTime*.001;for(let c of this.activePlugins)c.onFrame&&c.onFrame(this,e,t,n);e.uniform1f(a,o),e.drawArrays(e.TRIANGLES,0,this.count)}renderLoop(){this.render(),this.frame=requestAnimationFrame(this.renderLoop)}createPrograms(){let{gl:e}=this;if(!e)throw Error("render failed: gl context not initialized.");let t={fragmentShader:this.fragCode,vertexShader:this.vertCode};for(let r of this.activePlugins)r.onBeforeCompileShader&&r.onBeforeCompileShader(t);let i=e.createProgram();if(!i)throw Error("createProgram failed.");if(this.program=i,this.fragShader=this.createShader(e.FRAGMENT_SHADER,t.fragmentShader),this.vertShader=this.createShader(e.VERTEX_SHADER,t.vertexShader),!this.fragShader||!this.vertShader)throw Error("createShader failed.");if(e.attachShader(i,this.fragShader),e.attachShader(i,this.vertShader),e.linkProgram(i),!e.getProgramParameter(i,e.LINK_STATUS))throw e.getProgramInfoLog(i);e.useProgram(i)}setup(){if(this.gl&&!this.gl.isContextLost())return;let e=document.createElement("canvas");if(e.style.width="100%",e.style.height="100%",e.style.display="block",this.canvas=e,this.appendChild(this.canvas),this.webgl2?this.gl=this.canvas.getContext("webgl2"):this.gl=this.canvas.getContext("webgl")||this.canvas.getContext("experimental-webgl"),!this.gl)throw new Error("WebGL not supported");this.activatePlugins(),this.createPrograms(),this.createBuffers(),this.prefersReducedMotion=l(),this.setupActivePlugins().then(()=>{this.initialized=!0,this.onResize()}),this.addEventListeners(),this.autoPlay&&(this.playState="running")}addEventListeners(){var e;window.addEventListener("resize",this.onResize,!1),(e=this.prefersReducedMotion)==null||e.addEventListener("change",this.onChangeReducedMotion,!1)}deactivatePlugins(){for(let e of this.activePlugins)e.dispose()}activatePlugins(){for(let e of d.plugins){let t=e();this.activePlugins.find(i=>i.name===t.name)||this.activePlugins.push(t)}}setupActivePlugins(){return new Promise((e,t)=>{if(!this.gl||!this.program||!this.canvas){t(Error("WebGL not initialized"));return}let i=[];for(let r of this.activePlugins){let n=r.setup(this,this.gl,this.program,this.canvas);n instanceof Promise&&i.push(n)}Promise.all(i).then(()=>{e()}).catch(r=>{t(r)})})}reinitialize(){this.deactivatePlugins(),this.deleteProgramAndBuffers(),this.createPrograms(),this.createBuffers(),this.activatePlugins(),this.onResize()}deleteProgramAndBuffers(){if(!this.gl)throw Error("no gl context initialized");Object.entries(this.buffers).forEach(([e,t])=>{this.gl&&this.gl.deleteBuffer(t.buffer)}),this.gl.deleteProgram(this.program)}dispose(){if(this.frame>-1&&cancelAnimationFrame(this.frame),this.frame=-1,this.initialized=!1,this.prefersReducedMotion&&this.prefersReducedMotion.removeEventListener("change",this.onChangeReducedMotion,!1),this.watch.reset(),this.deactivatePlugins(),window.removeEventListener("resize",this.onResize,!1),this.deleteProgramAndBuffers(),this.gl){let e=this.gl.getExtension("WEBGL_lose_context");e&&typeof e.loseContext=="function"&&e.loseContext(),this.gl=null}this.canvas&&(this.removeChild(this.canvas),this.canvas=null),this.buffers={}}},u=d;u.plugins=[];export{u as ShaderArt,h as Stopwatch,l as prefersReducedMotion};
